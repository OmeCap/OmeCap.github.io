<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Game</title>
        <link rel="icon" href="./images/icon_web.png">
        <link rel="stylesheet" type="text/css" href="./css/style.css">  

        <!-- Load libraries via unpkg -->
        <!-- Blockly -->
        <script src="https://unpkg.com/blockly@8.0.3/blockly.min.js"></script>
        <!-- Blockly Gamepad -->
        <script src="https://unpkg.com/blockly-gamepad"></script>

    </head>
    <body>
        <header>
            <span class="title">
                <div><a class="link" href="index.html">Game</a><span id="levelName"></span></div>
            </span>
            <div id="btnDiv" style="margin-left: 110px;">
                <span class="switch_span">Levels</span>
                <button class="button level" id="level_1">1</button>
                <button class="button level" id="level_2">2</button>
                <button class="button level" id="level_3">3</button>
                <button class="button level" id="level_4">4</button>
                <button class="button level" id="level_5">5</button>
            </div>
        </header>
        <main>
            <!--game div (game map)-->
            <div id="game-div">
                <!--level 1: Basic Operations-->
                <svg xmlns="http://www.w3.org/2000/svg" style="display: none; background-color: #fffff0;" id="1" width="400px"
                    height="400px" viewBox="0 0 400 400">
                    <image xlink:href="images/map1.png" x="0" y="-1" width="400" height="400"></image>
                    <image id="finish1" xlink:href="images/destination.png" height="34" width="20" x="215" y="146"></image>
                    <clipPath id="carClipPath1">
                        <rect id="clipRect1" width="49" height="52" x="101" y="191"></rect>
                    </clipPath>
                    <image id="car1" xlink:href="images/car.png" height="64" width="1029"
                        clip-path="url(#carClipPath1)" x="-95" y="191" transform="rotate(0, 0, 0)"></image>
                </svg>
                <!--level 2: Loop-->
                <svg xmlns="http://www.w3.org/2000/svg" style="display: none; background-color: #fffff0;" id="2" width="400px"
                    height="400px" viewBox="0 0 400 400">
                    <image xlink:href="images/map2.png" x="0" y="-1" width="400" height="400"></image>
                    <image id="finish2" xlink:href="images/destination.png" height="34" width="20" x="340" y="195"></image>
                    <clipPath id="carClipPath2">
                        <rect id="clipRect2" width="49" height="52" x="50" y="290"></rect>
                    </clipPath>
                    <image id="car2" xlink:href="images/car.png" height="64" width="1029"
                        clip-path="url(#carClipPath2)" x="49" y="290" transform="rotate(0, 0, 0)"></image>
                </svg>
                <!--level 3: Loop and If Statement-->
                <svg xmlns="http://www.w3.org/2000/svg" style="display: none; background-color: #fffff0;" id="3" width="400px"
                    height="400px" viewBox="0 0 400 400">
                    <image xlink:href="images/map3.png" x="0" y="0" width="400" height="400"></image>
                    <image id="finish3" xlink:href="images/destination.png" height="34" width="20" x="65" y="100"></image>
                    <image id="coin1" xlink:href="images/coin.png" height="34" width="20" x="265" y="305"></image>
                    <image id="coin2" xlink:href="images/coin.png" height="34" width="20" x="265" y="100"></image>
                    <clipPath id="carClipPath3">
                        <rect id="clipRect3" width="49" height="52" x="51" y="291"></rect>
                    </clipPath>
                    <image id="car3" xlink:href="images/car.png" height="64" width="1029"
                        clip-path="url(#carClipPath3)" x="-145" y="291" transform="rotate(0, 0, 0)"></image>
                </svg>
                <!--level 4: Loop and If-else Statement-->
                <svg xmlns="http://www.w3.org/2000/svg" style="display: none; background-color: #fffff0;" id="4" width="400px"
                    height="400px" viewBox="0 0 400 400">
                    <image xlink:href="images/map4.png" x="0" y="-1" width="400" height="400"></image>
                    <image id="finish4" xlink:href="images/destination.png" height="34" width="20" x="315" y="300"></image>
                    <clipPath id="carClipPath4">
                        <rect id="clipRect4" width="49" height="52" x="50" y="290"></rect>
                    </clipPath>
                    <image id="car4" xlink:href="images/car.png" height="64" width="1029"
                        clip-path="url(#carClipPath4)" x="49" y="290" transform="rotate(0, 0, 0)"></image>
                </svg>
                <!--level 5: Challenge-->
                <svg xmlns="http://www.w3.org/2000/svg" style="display: none; background-color: #fffff0;" id="5" width="400px"
                    height="400px" viewBox="0 0 400 400">
                    <image xlink:href="images/map5.png" x="0" y="0" width="400" height="400"></image>
                    <image id="finish5" xlink:href="images/destination.png" height="34" width="20" x="215" y="46"></image>
                    <clipPath id="carClipPath5">
                        <rect id="clipRect5" width="49" height="52" x="51" y="291"></rect>
                    </clipPath>
                    <image id="car5" xlink:href="images/car.png" height="64" width="1029"
                        clip-path="url(#carClipPath5)" x="-145" y="291" transform="rotate(0, 0, 0)"></image>
                </svg>

                <!--capacity div-->
                <div id="capacity" style="display: none;">You have <span id="capacityNumber"></span> blocks left.</div>
                
                <div id="coinNumber"><image src="images/coin.png" height="20" width="20"></image> x <span id="currentCoinNumber">0</span></div> 
                
                <!--buttons-->
                <div class="buttons">
                    <button id="loadCode" class="button violet" style="grid-area: 1"> &nbsp;Load&ensp;code</button>
                    <button id="showCode" class="button violet" style="grid-area: 1"> &nbsp;Show&ensp;code</button>
                    <hr>
                    <button id="play" class="button green" style="grid-area: 1">Play</button>
                    <button id="pause" class="button green" style="grid-area: 2">Pause</button>
                    <hr>
                    <button id="forward" class="button blue" style="grid-area: 2">Forward</button>
                    <button id="backward" class="button blue" style="grid-area: 3">Backward</button>
                </div>
            </div>
            <!--workspace div-->
            <div id="blockly-editor">
                <div id="blockly-div"></div>
                <!--toolbox-->
                <xml id="toolbox" style="display: none">
                    <block type="move"></block>
                    <block type="turn"></block>
                    <block type="turn">
                        <field name="DIRECTION">3</field>
                    </block>
                    <block type="collect"></block>
                    <block type="repeat_until"></block>
                    <block type="if_path"></block>
                    <block type="if_else_path"></block>
                </xml>
            </div>
        </main>
    
        <!--load global parameters-->
        <script src="./script/utility.js"></script>
        <script>
            // get the level id from url
            let {id} = actions.getUrlVars();


            // change the level name, highlight the level button and set the id
            switch(id) {
                case '2':
                    document.getElementById('levelName').innerHTML = ': Level 2 - Loop';
                    document.getElementById('level_' + id).className += ' active';
                    id = 1;
                    break;
                case '3':
                    document.getElementById('levelName').innerHTML = ': Level 3 - Loop and If Statement';
                    document.getElementById('level_' + id).className += ' active';
                    id = 2;
                    break;
                case '4':
                    document.getElementById('levelName').innerHTML = ': Level 4 - Loop and If-else Statement';
                    document.getElementById('level_' + id).className += ' active';
                    id = 3
                    break;
                case '5':
                    document.getElementById('levelName').innerHTML = ': Level 5 - Challenge';
                    document.getElementById('level_' + id).className += ' active';
                    id = 4
                    break;
                default:
                    id = 0;
                    document.getElementById('levelName').innerHTML = ': Level 1 - Basic Operations';
                    document.getElementById('level_' + (id + 1)).className += ' active';
                    break;
            }
    
            // set the toolbox
            const toolbox = document.getElementById('toolbox');
        </script>
    
        <!--scripts-->
        <script src="script/levels.js"></script>
        <script src="script/gui.js"></script>
        <script src="script/game.js"></script>
        <script src="script/gamepadSettings.js"></script>
       
        <!--link event to buttons-->
        <script>
            // onclick events for level buttons
            // - load the level 
            // - update the url
            // - clear the console
            document.getElementById('level_1').onclick = () => {
                game.loadLevel(levels[id = 0]);
                window.location.href = 'game.html?' + 'id=' + (id + 1);
                console.clear();
            };
            document.getElementById('level_2').onclick = () => {
                game.loadLevel(levels[id = 1]); 
                window.location.href = 'game.html?' + 'id=' + (id + 1);
                console.clear();
            };
            document.getElementById('level_3').onclick = () => {
                game.loadLevel(levels[id = 2]);
                window.location.href = 'game.html?' + 'id=' + (id + 1);
                console.clear();
            };
            document.getElementById('level_4').onclick = () => {
                game.loadLevel(levels[id = 3]);
                window.location.href = 'game.html?' + 'id=' + (id + 1);
                console.clear();
            };
            document.getElementById('level_5').onclick = () => {
                game.loadLevel(levels[id = 4]);
                window.location.href = 'game.html?' + 'id=' + (id + 1);
                console.clear();
            };

            // onclick events for functions
            document.getElementById('loadCode').onclick = () => {
                game.loadCode();
                console.clear();
            };
            document.getElementById('showCode').onclick = () => {
                var code = Blockly.JavaScript.workspaceToCode(workspace)
                alert(code)
            }
            document.getElementById('forward').onclick = () => {
                gamepad.forward();
            };
            document.getElementById('backward').onclick = () => {
                gamepad.backward();
            };
            document.getElementById('play').onclick = () => {
                gamepad.play();
            };
            document.getElementById('pause').onclick = () => {
                gamepad.pause();
            };
        </script>
        
        <!--display remaining block-->
        <script>
            // update remaining block
            Blockly.getMainWorkspace().addChangeListener(() => {
                let capacity = Blockly.getMainWorkspace().remainingCapacity()
                if (capacity != Infinity) {
                    // show capacity div
                    document.getElementById('capacity').style.display = 'block';
                    document.getElementById('capacityNumber').innerHTML = capacity;
                } else {
                    // hide capacity div
                    document.getElementById('capacity').style.display = 'none';
                }
            })
        </script>
    </body>
</html>